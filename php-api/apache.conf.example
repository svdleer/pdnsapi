# PDNSAdmin PHP API - Apache Configuration with SSL
# 
# This configuration provides HTTPS support with HTTP to HTTPS redirection
# and proper security headers for the PDNSAdmin PHP API.

# Global SSL Configuration (add to main Apache config or here)
# OCSP Stapling Cache - must be outside VirtualHost
SSLStaplingCache "shmcb:${APACHE_RUN_DIR}/ssl_stapling(32768)"

# HTTP Virtual Host - Redirect to HTTPS
<VirtualHost *:80>
    ServerName pdnsapi.avant.nl
    ServerAlias www.pdnsapi.avant.nl
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    
    # Optional: Serve Let's Encrypt challenge files
    Alias /.well-known/acme-challenge/ /var/www/letsencrypt/.well-known/acme-challenge/
    <Directory "/var/www/letsencrypt/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>

# HTTPS Virtual Host - Main API
<VirtualHost *:443>
    ServerName pdnsapi.avant.nl
    ServerAlias www.pdnsapi.avant.nl
    DocumentRoot /opt/web/pdnsapi.avant.nl/php-api
    DirectoryIndex index.php

    # SSL Configuration
    SSLEngine on
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # SSL Certificate files (update these paths)
    SSLCertificateFile /etc/ssl/certs/pdnsapi.avant.nl.crt
    SSLCertificateKeyFile /etc/ssl/private/pdnsapi.avant.nl.key
    SSLCertificateChainFile /etc/ssl/certs/pdnsapi.avant.nl-chain.crt
    
    # OCSP Stapling (cache configured globally above)
    SSLUseStapling On

    # Root directory permissions (if needed)
    <Directory /opt/web/pdnsapi.avant.nl>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Main API directory permissions
    <Directory /opt/web/pdnsapi.avant.nl/php-api>
        Options -Indexes +FollowSymLinks +ExecCGI
        AllowOverride All
        Require all granted
        
        # Enable PHP processing
        <FilesMatch "\.php$">
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # API URL Rewriting
    RewriteEngine On
    
    # Redirect API calls to appropriate endpoints
    RewriteRule ^/?accounts/?(.*)$ /api/accounts.php?$1 [L,QSA]
    RewriteRule ^/?domains/?(.*)$ /api/domains.php?$1 [L,QSA]
    RewriteRule ^/?status/?(.*)$ /api/status.php?$1 [L,QSA]
    RewriteRule ^/?domain-account/?(.*)$ /api/domain-account.php?$1 [L,QSA]

    # Security: Deny access to sensitive directories
    <Directory /opt/web/pdnsapi.avant.nl/php-api/config>
        Require all denied
    </Directory>

    <Directory /opt/web/pdnsapi.avant.nl/php-api/database>
        Require all denied
    </Directory>

    # Deny access to .git directory and other version control
    <DirectoryMatch "/(\.git|\.svn|\.hg)/">
        Require all denied
    </DirectoryMatch>

    # Deny access to backup and temporary files
    <FilesMatch "\.(bak|backup|tmp|temp|old|orig|save)$">
        Require all denied
    </FilesMatch>

    # Enhanced Security Headers for HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' unpkg.com; style-src 'self' 'unsafe-inline' unpkg.com; img-src 'self' data:; connect-src 'self'"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/pdns-api-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/pdns-api-ssl-access.log combined
</VirtualHost>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/pdns-api-error.log
    CustomLog ${APACHE_LOG_DIR}/pdns-api-access.log combined
</VirtualHost>
