# PDNSAdmin PHP API - Apache Configuration
# 
# This configuration provides proper access controls and security headers
# for the PDNSAdmin PHP API.

<VirtualHost *:80>
    ServerName pdnsapi.your-domain.com
    DocumentRoot /opt/web/pdnsadpi.avant.nl/php-api
    DirectoryIndex index.php

    # Main API directory permissions
    <Directory /opt/web/pdnsadpi.avant.nl/php-api>
        Options -Indexes +FollowSymLinks +ExecCGI
        AllowOverride All
        Require all granted
        
        # Enable PHP processing
        <FilesMatch "\.php$">
            SetHandler application/x-httpd-php
        </FilesMatch>
    </Directory>

    # Root directory permissions (if needed)
    <Directory /opt/web/pdnsadpi.avant.nl>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # API URL Rewriting
    RewriteEngine On
    
    # Redirect API calls to appropriate endpoints
    RewriteRule ^/?accounts/?(.*)$ /api/accounts.php?$1 [L,QSA]
    RewriteRule ^/?domains/?(.*)$ /api/domains.php?$1 [L,QSA]
    RewriteRule ^/?status/?(.*)$ /api/status.php?$1 [L,QSA]
    RewriteRule ^/?domain-account/?(.*)$ /api/domain-account.php?$1 [L,QSA]

    # Security: Deny access to sensitive directories
    <Directory /opt/web/pdnsadpi.avant.nl/php-api/config>
        Require all denied
    </Directory>

    <Directory /opt/web/pdnsadpi.avant.nl/php-api/database>
        Require all denied
    </Directory>

    # Deny access to .git directory and other version control
    <DirectoryMatch "/(\.git|\.svn|\.hg)/">
        Require all denied
    </DirectoryMatch>

    # Deny access to backup and temporary files
    <FilesMatch "\.(bak|backup|tmp|temp|old|orig|save)$">
        Require all denied
    </FilesMatch>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/pdns-api-error.log
    CustomLog ${APACHE_LOG_DIR}/pdns-api-access.log combined
</VirtualHost>
